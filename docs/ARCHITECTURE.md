โโโ app
โยย โโโ __init__.py
โยย โโโ __pycache__
โยย โยย โโโ __init__.cpython-311.pyc
โยย โยย โโโ config_limits.cpython-311.pyc
โยย โยย โโโ config.cpython-311.pyc
โยย โยย โโโ main.cpython-311.pyc
โยย โโโ bot
โยย โยย โโโ __init__.py
โยย โยย โโโ __pycache__
โยย โยย โยย โโโ __init__.cpython-311.pyc
โยย โยย โยย โโโ keyboards.cpython-311.pyc
โยย โยย โยย โโโ states.cpython-311.pyc
โยย โยย โโโ handlers
โยย โยย โยย โโโ __init__.py
โยย โยย โยย โโโ __pycache__
โยย โยย โยย โยย โโโ __init__.cpython-311.pyc
โยย โยย โยย โยย โโโ admin.cpython-311.pyc
โยย โยย โยย โยย โโโ analysis.cpython-311.pyc
โยย โยย โยย โยย โโโ common.cpython-311.pyc
โยย โยย โยย โยย โโโ main_menu.cpython-311.pyc
โยย โยย โยย โยย โโโ payments.cpython-311.pyc
โยย โยย โยย โยย โโโ premium.cpython-311.pyc
โยย โยย โยย โยย โโโ profile.cpython-311.pyc
โยย โยย โยย โยย โโโ reports.cpython-311.pyc
โยย โยย โยย โโโ admin.py
โยย โยย โยย โโโ analysis.py
โยย โยย โยย โโโ common.py
โยย โยย โยย โโโ main_menu.py
โยย โยย โยย โโโ payments.py
โยย โยย โยย โโโ premium.py
โยย โยย โยย โโโ profile.py
โยย โยย โยย โโโ reports.py
โยย โยย โโโ keyboards.py
โยย โยย โโโ middlewares
โยย โยย โยย โโโ __pycache__
โยย โยย โยย โยย โโโ user.cpython-311.pyc
โยย โยย โยย โโโ user.py
โยย โยย โโโ states.py
โยย โโโ config_limits.py
โยย โโโ config.py
โยย โโโ db
โยย โยย โโโ __init__.py
โยย โยย โโโ __pycache__
โยย โยย โยย โโโ __init__.cpython-311.pyc
โยย โยย โยย โโโ base.cpython-311.pyc
โยย โยย โยย โโโ models.cpython-311.pyc
โยย โยย โโโ base.py
โยย โยย โโโ models.py
โยย โยย โโโ repositories
โยย โยย     โโโ __init__.py
โยย โยย     โโโ __pycache__
โยย โยย     โยย โโโ __init__.cpython-311.pyc
โยย โยย     โยย โโโ user_repository.cpython-311.pyc
โยย โยย     โโโ user_repository.py
โยย โโโ locales
โยย โยย โโโ __init__.py
โยย โยย โโโ __pycache__
โยย โยย โยย โโโ __init__.cpython-311.pyc
โยย โยย โโโ ru
โยย โยย     โโโ __init__.py
โยย โยย     โโโ __pycache__
โยย โยย     โยย โโโ __init__.cpython-311.pyc
โยย โยย     โยย โโโ buttons.cpython-311.pyc
โยย โยย     โยย โโโ texts.cpython-311.pyc
โยย โยย     โโโ buttons.py
โยย โยย     โโโ texts.py
โยย โโโ main.py
โยย โโโ prompts
โยย โยย โโโ __init__.py
โยย โยย โโโ __pycache__
โยย โยย โยย โโโ __init__.cpython-311.pyc
โยย โยย โยย โโโ food_analysis.cpython-311.pyc
โยย โยย โโโ food_analysis.py
โยย โโโ services
โยย     โโโ __init__.py
โยย     โโโ __pycache__
โยย     โยย โโโ __init__.cpython-311.pyc
โยย     โยย โโโ gpt_client.cpython-311.pyc
โยย     โยย โโโ limit_service.cpython-311.pyc
โยย     โยย โโโ promo_service.cpython-311.pyc
โยย     โยย โโโ user_service.cpython-311.pyc
โยย     โโโ gpt_client.py
โยย     โโโ limit_service.py
โยย     โโโ promo_service.py
โยย     โโโ user_service.py
โโโ db_migrations
โยย โโโ 001_add_paid_photos_balance.sql
โโโ docker-compose.yml
โโโ docs
โยย โโโ 01_overview.md
โยย โโโ 02_navigation_and_fsm.md
โยย โโโ 03_user_stories.md
โยย โโโ 04_db_schema.md
โยย โโโ 05_openai_prompts.md
โยย โโโ 06_abuse_protection.md
โยย โโโ 07_nonfunctional_requirements.md
โยย โโโ 08_localization_ru.md
โยย โโโ ARCHITECTURE.md
โยย โโโ Project_plan.md
โโโ dump_files.sh
โโโ Makefile
โโโ README.md
โโโ requirements.txt
โโโ scripts
    โโโ init_project.sh


---

````markdown
# DishVisionBot โ ััััะบัััะฐ ะฟัะพะตะบัะฐ ะธ ัะฒัะทั ั ะฐััะธัะตะบัััะพะน

ะญัะพั ะดะพะบัะผะตะฝั ะพะฟะธััะฒะฐะตั, **ะบะฐะบ ัะฐะนะปะพะฒะฐั ััััะบัััะฐ ะฟัะพะตะบัะฐ ัะพะพัะฒะตัััะฒัะตั ะฐััะธัะตะบัััะต ะฟัะธะปะพะถะตะฝะธั**, ะธ ะดะฐัั ะบะพัะพัะบะพะต ะพะฑัััะฝะตะฝะธะต **ยซะทะฐัะตะผยป ะฝัะถะตะฝ ะบะฐะถะดัะน ัะฐะทะดะตะป**.

---

## 1. ะะตััะฝะธะน ััะพะฒะตะฝั ัะตะฟะพะทะธัะพัะธั

```text
.
โโโ app/
โโโ db_migrations/
โโโ docker-compose.yml
โโโ docs/
โโโ dump_files.sh
โโโ Makefile
โโโ README.md
โโโ requirements.txt
โโโ scripts/
````

### `app/` โ ะธััะพะดะฝัะน ะบะพะด ะฟัะธะปะพะถะตะฝะธั

* **ะงัะพ ััะพ:** ะฒัั ะฟัะธะปะพะถะตะฝะธะต DishVisionBot โ ะพั Telegram-ัะปะพั ะดะพ ัะฐะฑะพัั ั ะะ ะธ GPT.
* **ะะฐัะตะผ:** ะทะดะตัั ะถะธะฒัั ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ, ัะตะฝะดะปะตัั, ะบะพะฝัะธะณััะฐัะธั, ะผะพะดะตะปะธ ะะ ะธ ัะตัะฒะธัั.

### `db_migrations/`

* **ะงัะพ ััะพ:** SQL-ะผะธะณัะฐัะธะธ ะดะปั ะฑะฐะทั ะดะฐะฝะฝัั.
* **ะะฐัะตะผ:** ะฟะพะทะฒะพะปัะตั ะธะทะผะตะฝััั ััะตะผั ะะ (ะดะพะฑะฐะฒะปััั ะฟะพะปั, ัะฐะฑะปะธัั) ัะตัะตะท ะฒะตััะธะพะฝะธััะตะผัะต ัะบัะธะฟัั, ะฐ ะฝะต ััะบะฐะผะธ ะฒ ะฟัะพะดะต.

ะัะธะผะตั:
`001_add_paid_photos_balance.sql` โ ะดะพะฑะฐะฒะปัะตั ะบะพะปะพะฝะบั `paid_photos_balance` ะดะปั ััััะฐ ะบัะฟะปะตะฝะฝัั ะฐะฝะฐะปะธะทะพะฒ.

### `docker-compose.yml`

* **ะงัะพ ััะพ:** ะพะฟะธัะฐะฝะธะต docker-ัะตัะฒะธัะพะฒ.
* **ะะฐัะตะผ:** ะฟะพะดะฝะธะผะฐะตั ะพะบััะถะตะฝะธะต (ะฒ ะฟะตัะฒัั ะพัะตัะตะดั PostgreSQL) ะดะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ ะธ, ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ, ะดะตะฟะปะพั.

### `docs/`

* **ะงัะพ ััะพ:** ะดะพะบัะผะตะฝัะฐัะธั ะฟัะพะตะบัะฐ.
* **ะะฐัะตะผ:** ะพะฟะธััะฒะฐะตั ััะตะฑะพะฒะฐะฝะธั, ะฐััะธัะตะบัััั, ััะตะผั ะะ, ะฟัะพะผะฟัั ะธ ั.ะฟ.

ะกะตะนัะฐั ะฒ `docs/`:

* `01_overview.md` โ ะพะฑัะธะน ะพะฑะทะพั ะฟัะพะดัะบัะฐ.
* `02_navigation_and_fsm.md` โ ะฝะฐะฒะธะณะฐัะธั ะฟะพ ะฑะพัั ะธ ัะพััะพัะฝะธั FSM.
* `03_user_stories.md` โ ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต ััะตะฝะฐัะธะธ.
* `04_db_schema.md` โ ััะตะผะฐ ะฑะฐะทั ะดะฐะฝะฝัั ะธ ัััะฝะพััะธ.
* `05_openai_prompts.md` โ ะพะฟะธัะฐะฝะธะต ะฟัะพะผะฟัะพะฒ ะดะปั GPT/vision.
* `06_abuse_protection.md` โ ะทะฐัะธัะฐ ะพั ะฐะฑัะทะฐ, ะปะธะผะธัั, ะฟัะฐะฒะธะปะฐ.
* `07_nonfunctional_requirements.md` โ ะฝะตััะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั.
* `08_localization_ru.md` โ ะปะพะบะฐะปะธะทะฐัะธั/ัะตะบััั ะฝะฐ ััััะบะพะผ.
* `ARCHITECTURE.md` โ ะพะฑัะฐั ะฐััะธัะตะบัััะฐ (ัะปะพะธ, ะผะพะดัะปะธ).
* `Project_plan.md` โ ะฟะปะฐะฝ ัะฐะทัะฐะฑะพัะบะธ.

### `dump_files.sh`

* **ะงัะพ ััะพ:** ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะน ัะบัะธะฟั ะดะปั ะฒัะณััะทะบะธ ะฒะฐะถะฝัั ัะฐะนะปะพะฒ (handlers, services ะธ ั.ะด.) ะฒ ะพะดะธะฝ ะฟะพัะพะบ ัะตะบััะฐ.
* **ะะฐัะตะผ:** ัะดะพะฑะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะดะปั ัะตะฒัั ะบะพะดะฐ/ะฟะตัะตะดะฐัะธ ะฐััะธััะตะฝัั ะฑะตะท ัััะฝะพะณะพ ะบะพะฟะธัะพะฒะฐะฝะธั ัะฐะนะปะพะฒ.

### `Makefile`

* **ะงัะพ ััะพ:** ะฝะฐะฑะพั ะบะพะผะฐะฝะด ะดะปั ัะฐะทัะฐะฑะพััะธะบะฐ.
* **ะะฐัะตะผ:** ัะฟัะพัะฐะตั ะทะฐะฟััะบ ัะธะฟะพะฒัั ะพะฟะตัะฐัะธะน: ััะฐัั/ัะตััะฐัั ะฑะพัะฐ, ะฟัะพะฒะตัะบะฐ ะพะบััะถะตะฝะธั ะธ ั.ะฟ.

ะขะธะฟะธัะฝัะต ัะตะปะธ:

* `make restart` โ ะฟะตัะตะทะฐะฟัััะธัั ะฑะพัะฐ (docker + python).
* `make run` / `make stop` โ ะทะฐะฟััะบ/ะพััะฐะฝะพะฒะบะฐ.
* `make check-env` โ ะฟัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั ะธ ั.ะด.

### `README.md`

* **ะงัะพ ััะพ:** ะบัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ะฟัะพะตะบัะฐ.
* **ะะฐัะตะผ:** ัะพัะบะฐ ะฒัะพะดะฐ ะดะปั ะฝะพะฒะพะณะพ ัะตะปะพะฒะตะบะฐ โ ะบะฐะบ ะทะฐะฟัััะธัั, ะบะฐะบะธะต ะทะฐะฒะธัะธะผะพััะธ.

### `requirements.txt`

* **ะงัะพ ััะพ:** ัะฟะธัะพะบ Python-ะทะฐะฒะธัะธะผะพััะตะน.
* **ะะฐัะตะผ:** ะฟะพะทะฒะพะปัะตั ัััะฐะฝะพะฒะธัั ะฝัะถะฝัะต ะฟะฐะบะตัั ัะตัะตะท `pip install -r requirements.txt`.

### `scripts/`

* **ะงัะพ ััะพ:** ัะปัะถะตะฑะฝัะต ัะบัะธะฟัั.
* **ะะฐัะตะผ:** ะฐะฒัะพะผะฐัะธะทะฐัะธั ัััะธะฝะฝัั ะพะฟะตัะฐัะธะน.

ะกะตะนัะฐั ัะฐะผ:

* `init_project.sh` โ ะฟะตัะฒะธัะฝะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะพะตะบัะฐ (ัะพะทะดะฐะฝะธะต ััััะบัััั, ัััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะธ ั.ะฟ.).

---

## 2. ะะฐะฟะบะฐ `app/` โ ะบะพะด ะฟัะธะปะพะถะตะฝะธั

```text
app/
โโโ bot/
โโโ db/
โโโ locales/
โโโ prompts/
โโโ services/
โโโ config.py
โโโ config_limits.py
โโโ main.py
```

### `app/main.py`

* **ะงัะพ ััะพ:** ัะพัะบะฐ ะฒัะพะดะฐ ะฒ ะฟัะธะปะพะถะตะฝะธะต.
* **ะะฐัะตะผ:** ัะพะทะดะฐัั ะฑะพัะฐ, ะฟะพะดะบะปััะฐะตั ัะตะฝะดะปะตัั, ะธะฝะธัะธะฐะปะธะทะธััะตั ะะ ะธ ะทะฐะฟััะบะฐะตั polling.

ะัะฝะพะฒะฝัะต ัะฐะณะธ ะฒะฝัััะธ:

1. ะงะธัะฐะตั ะฝะฐัััะพะนะบะธ ะธะท `Settings` (`app/config.py`).
2. ะัะทัะฒะฐะตั `init_db()` ะธะท `app/db/base.py`.
3. ะกะพะทะดะฐัั `Bot` ะธ `Dispatcher`.
4. ะะพะดะบะปััะฐะตั ัะพััะตัั ะธะท `app/bot/handlers/`.
5. ะะฐะฟััะบะฐะตั `dp.start_polling(bot)`.

### `app/config.py`

* **ะงัะพ ััะพ:** ะบะพะฝัะธะณััะฐัะธั ะฟัะธะปะพะถะตะฝะธั ัะตัะตะท Pydantic Settings.
* **ะะฐัะตะผ:** ัะดะพะฑะฝะพ ัะฟัะฐะฒะปััั ะฟะตัะตะผะตะฝะฝัะผะธ ะพะบััะถะตะฝะธั (.env).

ะะปััะตะฒัะต ะฟะพะปั:

* `bot_token`, `openai_api_key`.
* `database_url` (PostgreSQL ัะตัะตะท asyncpg).
* `default_language`, `log_level`, `api_timeout`, `max_file_size`.
* `admin_user_ids` โ ัะฟะธัะพะบ ะฐะดะผะธะฝะพะฒ (ัะตัะตะท ะทะฐะฟัััั).

### `app/config_limits.py`

* **ะงัะพ ััะพ:** ะฝะฐัััะพะนะบะธ ะปะธะผะธัะพะฒ ะธ ัะฐัะธัะพะฒ.
* **ะะฐัะตะผ:** ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพ ะทะฐะดะฐัั ะฑะธะทะฝะตั-ะพะณัะฐะฝะธัะตะฝะธั ะธ ัะตะฝั.

ะัะธะผะตัั:

* ะะฝะตะฒะฝัะต ะปะธะผะธัั: `FREE_DAILY_ANALYSES`, `PREMIUM_DAILY_ANALYSES`.
* ะะธะผะธัั ััะพัะฝะตะฝะธะน: `FREE_REFINEMENTS`, `PREMIUM_REFINEMENTS`.
* ะะณัะฐะฝะธัะตะฝะธั ะฟะพ ัะตััะธะธ: `PHOTO_SESSION_MAX_MESSAGES`, `PHOTO_SESSION_TIMEOUT_MINUTES`.
* ะฆะตะฝะฐ ะทะฐ ะฟะฐะบะตัั ะธ ะฟะพะดะฟะธัะบะธ: `STARS_PREMIUM_WEEK`, `STARS_PREMIUM_MONTH`, `PRICE_PER_ANALYSIS`.

---

## 3. Telegram-ัะปะพะน: `app/bot/`

```text
app/bot/
โโโ handlers/
โโโ middlewares/
โโโ keyboards.py
โโโ states.py
```

### ะะฑัะฐั ัะพะปั

* **ะงัะพ ััะพ:** ะฒัั, ััะพ ัะฒัะทะฐะฝะพ ั Telegram API.
* **ะะฐัะตะผ:** ะฟัะธะฝะธะผะฐะตั ัะพะพะฑัะตะฝะธั ะพั ะฟะพะปัะทะพะฒะฐัะตะปั, ะฟะตัะตะฒะพะดะธั ะธั ะฒ ะฒัะทะพะฒั ะฑะธะทะฝะตั-ะปะพะณะธะบะธ ะธ ะพัะฟัะฐะฒะปัะตั ะพัะฒะตัั.

### `app/bot/states.py`

* **ะงัะพ ััะพ:** ะพะฟะธัะฐะฝะธะต FSM-ัะพััะพัะฝะธะน (`aiogram.fsm`).
* **ะะฐัะตะผ:** ัะฟัะฐะฒะปัะตั ััะตะฝะฐัะธัะผะธ ะดะธะฐะปะพะณะฐ.

ะัะธะผะตัั ัะพััะพัะฝะธะน:

* `UserStates.STANDARD` โ ะพะฑััะฝัะน ัะตะถะธะผ (ะณะปะฐะฒะฝะพะต ะผะตะฝั).
* `UserStates.PHOTO_COMMENT` โ ะฟะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะธะป ัะพัะพ, ะฑะพั ะถะดัั ััะพัะฝะตะฝะธั/ะบะพะผะฐะฝะดั.
* `UserStates.PROMO` โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะฟัะพะผะพะบะพะด.
* ะะดะผะธะฝัะบะธะต ัะพััะพัะฝะธั (ะตัะปะธ ะตััั).

### `app/bot/keyboards.py`

* **ะงัะพ ััะพ:** ะฒัะต ะบะปะฐะฒะธะฐัััั (Reply ะธ Inline).
* **ะะฐัะตะผ:** ะฒัะฝะพัะธั ัะฐะทะผะตัะบั ะบะฝะพะฟะพะบ ะธะท ะฑะธะทะฝะตั-ะปะพะณะธะบะธ.

ะัะธะผะตัั:

* `main_menu_kb()` โ ะณะปะฐะฒะฝะพะต ะผะตะฝั: ยซะะฝะฐะปะธะทะธัะพะฒะฐัั ะตะดัยป, ยซะัะพัะธะปัยป, ยซะัะฟะธัั ะฟัะตะผะธัะผยป, ยซะะพะผะพััยป.
* `analysis_menu_kb()` โ ะผะตะฝั ะฒ ัะตะถะธะผะต ะฐะฝะฐะปะธะทะฐ ัะพัะพ: ยซะะฐะปะพัะธะนะฝะพัััยป, ยซะะตัะตะฟัยป, ยซะะพะฒะพะต ัะพัะพยป, ยซะะฐะทะฐะดยป.
* `premium_menu_kb()` โ ะฒัะฑะพั ัะฐัะธัะฐ + ะฟัะพะผะพะบะพะด.
* `buy_more_analyses_inline_kb()` โ ะธะฝะปะฐะนะฝ-ะบะฝะพะฟะบะฐ ะฟะพะบัะฟะบะธ 5 ะฐะฝะฐะปะธะทะพะฒ.
* `admin_menu_kb()`, `admin_limits_menu_kb()` โ ะบะปะฐะฒะธะฐัััั ะดะปั ะฐะดะผะธะฝะบะธ.

### `app/bot/middlewares/`

```text
app/bot/middlewares/
โโโ user.py
```

* **ะงัะพ ััะพ:** middleware ะดะปั ะพะฑัะฐะฑะพััะธะบะพะฒ.
* **ะะฐัะตะผ:** ะฒัะฟะพะปะฝัะตั ะพะฑัะธะต ะฒะตัะธ ะดะปั ะบะฐะถะดะพะณะพ ะฐะฟะดะตะนัะฐ, ะฝะฐะฟัะธะผะตั:

  * ะฟะพะดะณะพัะพะฒะบะฐ ะบะพะฝัะตะบััะฐ,
  * ะฒัะฝะตัะตะฝะฝะฐั ะปะพะณะธะบะฐ ัะฐะฑะพัั ั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ,
  * ะปะพะณะธัะพะฒะฐะฝะธะต.

`user.py` ะพะฑััะฝะพ ะพัะฒะตัะฐะตั ะทะฐ ะฟะพะปััะตะฝะธะต/ัะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฟัะธะฒัะทะบั ะบ ะบะพะฝัะตะบััั.

---

## 4. ะฅะตะฝะดะปะตัั: `app/bot/handlers/`

```text
app/bot/handlers/
โโโ admin.py
โโโ analysis.py
โโโ common.py
โโโ main_menu.py
โโโ payments.py
โโโ premium.py
โโโ profile.py
โโโ reports.py
```

### `__init__.py`

* **ะงัะพ ััะพ:** ัะฑะพัะบะฐ ะบะพัะฝะตะฒะพะณะพ `Router`.
* **ะะฐัะตะผ:** ะธะผะฟะพััะธััะตั ะฒัะต ะผะพะดัะปัะฝัะต ัะพััะตัั (main_menu, analysis, profile ะธ ั.ะด.) ะธ ะพะฑัะตะดะธะฝัะตั ะธั ะฒ ะพะดะธะฝ `router`, ะบะพัะพััะน ะฟะพะดะบะปััะฐะตััั ะฒ `main.py`.

### `main_menu.py`

* **ะงัะพ ััะพ:** ัะตะฝะดะปะตัั ะณะปะฐะฒะฝะพะณะพ ะผะตะฝั.
* **ะะฐัะตะผ:** ะพะฑัะฐะฑะฐััะฒะฐะตั `/start` ะธ ะบะฝะพะฟะบะธ ะฒะตััะฝะตะณะพ ััะพะฒะฝั.

ะัะฝะพะฒะฝัะต ะทะฐะดะฐัะธ:

* `/start`:

  * ะฟะพะบะฐะทัะฒะฐะตั ัะฐััะธัะตะฝะฝะพะต ะฟัะธะฒะตัััะฒะธะต (`start_welcome`);
  * ะฟะพะบะฐะทัะฒะฐะตั ััะฐััั ะธ ะณะปะฐะฒะฝะพะต ะผะตะฝั.
* ะะฝะพะฟะบะฐ ยซะะฝะฐะปะธะทะธัะพะฒะฐัั ะตะดัยป:

  * ะฟัะพะฒะตััะตั ะปะธะผะธัั (ะฑะตัะฟะปะฐัะฝัะต + ะฟะปะฐัะฝัะต);
  * ะฟะตัะตะฒะพะดะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะตะถะธะผ `PHOTO_COMMENT` ะธะปะธ ะฟัะตะดะปะฐะณะฐะตั ะดะพะบัะฟะธัั.
* ะะฝะพะฟะบะฐ ยซะะพะผะพััยป:

  * ะฟะพะบะฐะทัะฒะฐะตั ัะฐััะธัะตะฝะฝะพะต ะพะฟะธัะฐะฝะธะต ะฒะพะทะผะพะถะฝะพััะตะน.
* ะะฝะพะฟะบะฐ ยซะัะฟะธัั ะฟัะตะผะธัะผยป:

  * ะพัะบััะฒะฐะตั ะผะตะฝั ะฟัะตะผะธัะผะฐ.
* ะะฝะพะฟะบะฐ ยซะัะพัะธะปัยป:

  * ะดะตะปะตะณะธััะตั ะปะพะณะธะบั ะฟัะพัะธะปั (ะธะปะธ ะฒัะตะผะตะฝะฝะฐั ะทะฐะณะปััะบะฐ).
* ะะฝะพะฟะบะฐ ยซะะฐะทะฐะดยป:

  * ะฒะพะทะฒัะฐัะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั.

### `analysis.py`

* **ะงัะพ ััะพ:** ะพัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ ะฐะฝะฐะปะธะทะฐ ะตะดั ะฟะพ ัะพัะพ.
* **ะะฐัะตะผ:** ัะตะฐะปะธะทัะตั ััะตะฝะฐัะธะน ยซะพัะฟัะฐะฒะธะป ัะพัะพ โ ะฟะพะปััะธะป ะบะฐะปะพัะธะนะฝะพััั/ัะตัะตะฟัยป ั ััััะพะผ ะปะธะผะธัะพะฒ.

ะัะฝะพะฒะฝัะต ัะฐััะธ:

* ะะฑัะฐะฑะพััะธะบ `F.photo`:

  * ะฟัะพะฒะตััะตั, ะตััั ะปะธ ะดะพัััะฟะฝัะต ะปะธะผะธัั (free + paid);
  * ัะพััะฐะฝัะตั `file_id`, ะบะพะผะผะตะฝัะฐัะธะน ะธ ัะพััะพัะฝะธะต ัะตััะธะธ ะฒ FSM;
  * ะฒัะฒะพะดะธั ะผะตะฝั ะฐะฝะฐะปะธะทะฐ.
* ะะฑัะฐะฑะพััะธะบะธ ะบะฝะพะฟะพะบ:

  * ยซะะฐะปะพัะธะนะฝะพัััยป โ ะฒัะทัะฒะฐะตั `analyze_nutrition()` ะธะท `gpt_client`.
  * ยซะะตัะตะฟัยป โ ะฒัะทัะฒะฐะตั `analyze_recipe()`.
* ะฃััั ะปะธะผะธัะพะฒ:

  * `_check_daily_limit()` โ ะฟัะพะฒะตััะตั ะฑะตัะฟะปะฐัะฝัะต + ะฟะปะฐัะฝัะต ะปะธะผะธัั.
  * `_check_and_increment_daily_limit()` โ ัะฟะธััะฒะฐะตั ะปะธะผะธั ัะตัะตะท `consume_photo_quota()`.
* ะะฑัะฐะฑะพััะธะบ ยซะะพะฒะพะต ัะพัะพยป:

  * ัะฑัะฐััะฒะฐะตั ัะพััะพัะฝะธะต ะฟะพ ัะตะบััะตะผั ัะพัะพ;
  * ะตัั ัะฐะท ะฟัะพะฒะตััะตั ะปะธะผะธัั; ะตัะปะธ ะฒัั ะธััะตัะฟะฐะฝะพ โ ะฟัะตะดะปะฐะณะฐะตั ะบัะฟะธัั ะฐะฝะฐะปะธะทั.
* ะขะตะบััะพะฒัะต ััะพัะฝะตะฝะธั:

  * ะฝะฐะบะฐะฟะปะธะฒะฐะตั ะบะพะผะผะตะฝัะฐัะธะน ะบ ัะพัะพ;
  * ัะปะตะดะธั ะทะฐ ะปะธะผะธัะพะผ ะฟะพะฟััะพะบ (`refinements_used` / `refinement_limit`).

### `profile.py`

* **ะงัะพ ััะพ:** ัะตะฝะดะปะตัั ะฟัะพัะธะปั ะธ ัะฑะพัะบะฐ ัะตะบััะฐ ยซะพ ะฟะพะปัะทะพะฒะฐัะตะปะตยป.
* **ะะฐัะตะผ:** ะฟะพะบะฐะทัะฒะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั ััะฐััั ัะฐัะธัะฐ, ะปะธะผะธัั ะธ ะบัะฟะปะตะฝะฝัะต ะฐะฝะฐะปะธะทั.

ะขะธะฟะพะฒะพะน ะฒัะฒะพะด:

```text
โญ๏ธ ะะพะดะฟะธัะบะฐ: ะะตัะฟะปะฐัะฝัะน
ะกะตะณะพะดะฝั ะฒั ะผะพะถะตัะต ัะดะตะปะฐัั: N ะฐะฝะฐะปะธะทะพะฒ.

๐ธ ะะฝะฐะปะธะทั ัะตะณะพะดะฝั:
โข ะธัะฟะพะปัะทะพะฒะฐะฝะพ: X ะธะท Y
โข ะพััะฐะปะพัั ัะตะณะพะดะฝั: Z

๐ฐ ะัะฟะปะตะฝะฝัะต ะฐะฝะฐะปะธะทั:
โข ะดะพัััะฟะฝะพ: K
โข ะพะฝะธ ะฝะต ัะณะพัะฐัั ะธ ะฝะต ะทะฐะฒะธััั ะพั ะดะฝะตะฒะฝะพะณะพ ะปะธะผะธัะฐ
```

ะกัะดะฐ ะถะต ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั:

* ะพัะพะฑัะฐะถะตะฝะธะต ะดะฐัั ะพะบะพะฝัะฐะฝะธั ะฟัะตะผะธัะผะฐ;
* ะฑัะดััะธะต ะฝะฐัััะพะนะบะธ (ะฝะฐะฟัะธะผะตั, ะฟะปะฐะฝ ะฟะพ ะบะฐะปะพัะธัะผ).

### `premium.py`

* **ะงัะพ ััะพ:** ะปะพะณะธะบะฐ ะฟัะตะผะธัะผ-ะฟะพะดะฟะธัะบะธ ะธ ะฟัะพะผะพะบะพะดะพะฒ.
* **ะะฐัะตะผ:** ัะฟัะฐะฒะปัะตั ะฒะฒะพะดะพะผ ะฟัะพะผะพะบะพะดะฐ, ะฟัะพะฒะตัะบะพะน ััะปะพะฒะธะน ะธ ะฟัะพะดะปะตะฝะธะตะผ ะฟัะตะผะธัะผะฐ.

ะัะฝะพะฒะฝะพะต:

* `open_premium_menu()` โ ะฟะพะบะฐะท ัะบัะฐะฝะฐ ะฟัะตะผะธัะผะฐ.
* ะกะพััะพัะฝะธะต `UserStates.PROMO`:

  * `on_enter_promo` โ ะฟะตัะตัะพะด ะฒ ัะตะถะธะผ ะฟัะพะผะพะบะพะดะฐ.
  * `on_promo_input` โ ะพะฑัะฐะฑะพัะบะฐ ะฒะฒะตะดัะฝะฝะพะณะพ ะบะพะดะฐ.
* `_apply_promo_code()`:

  * ะฟัะพะฒะตััะตั ะฑะฐะฝ ะฟะพ ะฟัะพะผะพะบะพะดะฐะผ (`PromoBan`);
  * ะธัะตั `PromoCode`, ะฟัะพะฒะตััะตั ััะพะบ ะดะตะนััะฒะธั ะธ ะปะธะผะธั ะฐะบัะธะฒะฐัะธะน;
  * ะฟัะพะฒะตััะตั, ะฐะบัะธะฒะธัะพะฒะฐะป ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ััะพั ะบะพะด ัะฐะฝะตะต;
  * ะฟัะพะดะปะตะฒะฐะตั `premium_until` ะธ ะฟะพะผะตัะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะบะฐะบ ะฟัะตะผะธัะผ;
  * ัะฒะตะปะธัะธะฒะฐะตั `activations`, ัะพะทะดะฐัั `PromoCodeActivation`.

### `payments.py`

* **ะงัะพ ััะพ:** ะธะฝัะตะณัะฐัะธั ั Telegram Stars (ะพะฟะปะฐัั).
* **ะะฐัะตะผ:** ะฟัะพะดะฐะถะฐ ะฟัะตะผะธัะผะฐ ะธ ะฟะฐะบะตัะพะฒ ะฐะฝะฐะปะธะทะพะฒ.

ะัะฝะพะฒะฝะพะต:

* ะฅะตะฝะดะปะตัั ะบะฝะพะฟะพะบ ะฟะพะบัะฟะบะธ:

  * `on_buy_premium_week` / `on_buy_premium_month` โ ะพัะฟัะฐะฒะปััั `send_invoice` ั `payload="premium_week"` / `"premium_month"`.
  * `on_buy_analyses_pack` โ ะพัะฟัะฐะฒะปัะตั invoice ะฝะฐ ะฟะฐะบะตั 5 ะฐะฝะฐะปะธะทะพะฒ (`payload="analyses_pack"`).
* `process_pre_checkout_query` โ ะฟะพะดัะฒะตัะถะดะฐะตั ะฟัะตะดะพะฟะปะฐัั (`pre_checkout_query.answer(ok=True)`).
* `on_successful_payment`:

  * ะฟะพ `invoice_payload` ะพะฟัะตะดะตะปัะตั, ััะพ ะบัะฟะปะตะฝะพ;
  * ะฒะบะปััะฐะตั ะฟัะตะผะธัะผ (`is_premium`, `premium_until`) ะธะปะธ ัะฒะตะปะธัะธะฒะฐะตั `paid_photos_balance`;
  * ะพัะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ัะตะบัั ะพะฑ ััะฟะตัะฝะพะน ะพะฟะปะฐัะต.

### `admin.py`

* **ะงัะพ ััะพ:** ัะตะฝะดะปะตัั ะฐะดะผะธะฝะบะธ.
* **ะะฐัะตะผ:** ัะปัะถะตะฑะฝัะต ะธะฝััััะผะตะฝัั ะดะปั ะฒะปะฐะดะตะปััะฐ ะฑะพัะฐ.

ะัะธะผะตัั ััะฝะบัะธะน:

* ะฟัะพัะผะพัั ััะฐัะธััะธะบะธ;
* ัะฑัะพั ะปะธะผะธัะพะฒ ัะตะฑะต/ะดััะณะพะผั ะฟะพะปัะทะพะฒะฐัะตะปั;
* ะฒะบะปััะตะฝะธะต/ะฒัะบะปััะตะฝะธะต ะฟัะตะผะธัะผะฐ;
* ัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะผะพะบะพะดะฐะผะธ.

### `common.py`

* **ะงัะพ ััะพ:** ะพะฑัะธะต ัะตะฝะดะปะตัั/ะปะพะณะธะบะฐ.
* **ะะฐัะตะผ:** ะพะฑัะฐะฑะฐััะฒะฐะตั ะบะพะผะฐะฝะดั ะธะปะธ ัะพะฑััะธั, ะฝะต ะพัะฝะพัััะธะตัั ะบ ะบะพะฝะบัะตัะฝะพะผั ะผะพะดัะปั (ะฝะฐะฟัะธะผะตั, `/start` ะฒ ะฟัะพัะปะพะผ, ะฑะฐะทะพะฒัะต ะพัะฒะตัั ะฟะพ ัะผะพะปัะฐะฝะธั ะธ ั.ะฟ.).

### `reports.py`

* **ะงัะพ ััะพ:** ะทะฐะณะพัะพะฒะบะฐ ะฟะพะด ะพััััั ะฟะพ ะฟะธัะฐะฝะธั.
* **ะะฐัะตะผ:** ัะตะนัะฐั ะปะธะฑะพ ะฝะตะดะพัััะฟะตะฝ ะฟะพะปัะทะพะฒะฐัะตะปั (ะบะฝะพะฟะบะฐ ัะบัััะฐ), ะปะธะฑะพ ะฒ ัะตะถะธะผะต ะทะฐะณะปััะบะธ, ะฝะพ ะทะฐะปะพะถะตะฝ ะบะฐะบ ะพัะดะตะปัะฝัะน ะผะพะดัะปั ะฝะฐ ะฑัะดััะตะต.

---

## 5. ะกะปะพะน ะดะฐะฝะฝัั: `app/db/`

```text
app/db/
โโโ base.py
โโโ models.py
โโโ repositories/
    โโโ user_repository.py
```

### `app/db/base.py`

* **ะงัะพ ััะพ:** ะฑะฐะทะพะฒะฐั ะฝะฐัััะพะนะบะฐ SQLAlchemy.
* **ะะฐัะตะผ:** ัะพะทะดะฐัั `engine`, `AsyncSessionLocal` ะธ ััะฝะบัะธั `init_db()`.

ะัะฟะพะปัะทัะตััั ะฒ `main.py` ะธ ะฒ ัะตัะฒะธัะฐั ะดะปั ะฟะพะปััะตะฝะธั ัะตััะธะน.

### `app/db/models.py`

* **ะงัะพ ััะพ:** SQLAlchemy-ะผะพะดะตะปะธ.
* **ะะฐัะตะผ:** ะพะฟะธััะฒะฐะตั ัะฐะฑะปะธัั ะะ ะธ ะธั ัะฒัะทั ั ะฑะธะทะฝะตั-ะปะพะณะธะบะพะน.

ะัะฝะพะฒะฝัะต ัััะฝะพััะธ:

* `User` โ ัะตะปะตะณัะฐะผ-ะฟะพะปัะทะพะฒะฐัะตะปั, ัะฐัะธั, ะฟัะตะผะธัะผ, ะฑะฐะปะฐะฝั ะฟะพะบัะฟะพะบ.
* ะขะฐะฑะปะธัั ะปะธะผะธัะพะฒ (ะดะฝะตะฒะฝัะต ะปะธะผะธัั ะฐะฝะฐะปะธะทะพะฒ).
* ะขะฐะฑะปะธัั ะดะปั ะฟัะพะผะพะบะพะดะพะฒ:

  * `PromoCode`
  * `PromoCodeActivation`
  * `PromoBan`

### `app/db/repositories/`

```text
app/db/repositories/
โโโ user_repository.py
```

* **ะงัะพ ััะพ:** ัะปะพะน ัะตะฟะพะทะธัะพัะธะตะฒ.
* **ะะฐัะตะผ:** ะธะฝะบะฐะฟััะปะธััะตั ัะธะฟะธัะฝัะต ะทะฐะฟัะพัั ะบ ะะ (ะฝะฐะฟัะธะผะตั, ะฟะพะธัะบ/ัะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั), ััะพะฑั ะฝะต ะดัะฑะปะธัะพะฒะฐัั SQL ะฒ ัะตะฝะดะปะตัะฐั ะธ ัะตัะฒะธัะฐั.

`user_repository.py` ัะพะดะตัะถะธั ััะฝะบัะธะธ ัะฐะฑะพัั ั `User` (ะฟะพะปััะตะฝะธะต, ัะพะทะดะฐะฝะธะต, ะฟะพะธัะบ ะฟะพ telegram_id ะธ ั.ะฟ.), ะบะพัะพััะต ะทะฐัะตะผ ะธัะฟะพะปัะทััััั ะฒ `user_service.py`.

---

## 6. ะะพะบะฐะปะธะทะฐัะธั: `app/locales/`

```text
app/locales/
โโโ ru/
    โโโ buttons.py
    โโโ texts.py
```

### `app/locales/ru/buttons.py`

* **ะงัะพ ััะพ:** ัะปะพะฒะฐัั ัะตะบััะพะฒ ะดะปั ะบะฝะพะฟะพะบ.
* **ะะฐัะตะผ:** ะดะฐัั ะตะดะธะฝัะน ะธััะพัะฝะธะบ ะฟัะฐะฒะดั ะดะปั ะฒัะตั ะบะฝะพะฟะพะบ (ะธั ัะตะบััะพะฒ), ััะพะฑั ะฝะต ะฑัะปะพ ยซะผะฐะณะธัะตัะบะธั ัััะพะบยป ะฟะพ ะฟัะพะตะบัั.

ะัะธะผะตัั ะบะปััะตะน:

* `"analyze_food"`, `"profile"`, `"buy_premium"`, `"help"`.
* `"nutrition"`, `"recipe"`, `"new_photo"`, `"back"`.
* ะะดะผะธะฝ-ะบะฝะพะฟะบะธ: `"admin_statistics"`, `"admin_manage_limits"` ะธ ั.ะด.

### `app/locales/ru/texts.py`

* **ะงัะพ ััะพ:** ะฒัะต ัะตะบััะพะฒัะต ัะพะพะฑัะตะฝะธั ะฑะพัะฐ.
* **ะะฐัะตะผ:** ะฟะพะทะฒะพะปัะตั ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพ ัะฟัะฐะฒะปััั ััััะบะธะผะธ ัะตะบััะฐะผะธ, ะพะฟะธัะฐะฝะธะตะผ ัะฐัะธัะพะฒ, ัะฟัะฐะฒะบะพะน ะธ ั.ะด.

ะัะธะผะตัั:

* `start_welcome` โ ะดะปะธะฝะฝะพะต ะฟัะธะฒะตัััะฒะธะต/ัะฟัะฐะฒะบะฐ.
* `welcome_free`, `welcome_premium` โ ะบะพัะพัะบะธะต ะฟัะธะฒะตัััะฒะธั ะฟะพ ัะฐัะธัั.
* `help_text` โ ัะฟัะฐะฒะบะฐ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฑะพัะฐ.
* `daily_limit_exceeded`, `buy_additional_analyses` โ ัะพะพะฑัะตะฝะธั ะพ ะปะธะผะธัะฐั ะธ ะฟัะตะดะปะพะถะตะฝะธะธ ะดะพะบัะฟะธัั.
* ะขะตะบััั ะฟัะพัะธะปั, ะพัะธะฑะพะบ, ะฟะพะดัะบะฐะทะพะบ.

---

## 7. ะัะพะผะฟัั: `app/prompts/`

```text
app/prompts/
โโโ food_analysis.py
```

* **ะงัะพ ััะพ:** ะพัะดะตะปัะฝัะน ะผะพะดัะปั ั ะฟัะพะผะฟัะฐะผะธ ะดะปั GPT/vision.
* **ะะฐัะตะผ:** ะพัะดะตะปัะตั ัะตะบััั ะธะฝััััะบัะธะน ะดะปั ะผะพะดะตะปะธ ะพั ะปะพะณะธะบะธ ะทะฐะฟัะพัะพะฒ, ััะพะฑั ะฑัะปะพ ัะดะพะฑะฝะพ ัะตะดะฐะบัะธัะพะฒะฐัั ะฟัะพะผะฟัั.

`food_analysis.py` ะพะฑััะฝะพ ัะพะดะตัะถะธั:

* ัะธััะตะผะฝัะต ัะพะพะฑัะตะฝะธั ะดะปั ะฐะฝะฐะปะธะทะฐ ะบะฐะปะพัะธะนะฝะพััะธ;
* ะธะฝััััะบัะธะธ ะดะปั ะณะตะฝะตัะฐัะธะธ ัะตัะตะฟัะฐ;
* ะฟัะฐะฒะธะปะฐ ัะพัะผะฐัะฐ ะพัะฒะตัะฐ (ััััะบัััะฐ ัะตะบััะฐ, ัะผะพะดะทะธ ะธ ั.ะด.).

---

## 8. ะกะตัะฒะธัั: `app/services/`

```text
app/services/
โโโ gpt_client.py
โโโ limit_service.py
โโโ promo_service.py
โโโ user_service.py
```

### ะะฑัะฐั ัะพะปั

* **ะงัะพ ััะพ:** ะฑะธะทะฝะตั-ัะปะพะน ะฑะตะท ะฟัะธะฒัะทะบะธ ะบ Telegram.
* **ะะฐัะตะผ:** ะทะดะตัั ัะพััะตะดะพัะพัะตะฝะฐ ยซะปะพะณะธะบะฐ ะฟัะพะดัะบัะฐยป โ ะปะธะผะธัั, ะฟะพะปัะทะพะฒะฐัะตะปะธ, ะฟัะพะผะพะบะพะดั, ะพะฑัะตะฝะธะต ั GPT.

### `gpt_client.py`

* **ะงัะพ ััะพ:** ะบะปะธะตะฝั ะดะปั OpenAI (GPT + vision).
* **ะะฐัะตะผ:** ะธะฝะบะฐะฟััะปะธััะตั ะฒัะต ะฒัะทะพะฒั ะบ API.

ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:

* `analyze_nutrition(image_bytes, comment)` โ ะฐะฝะฐะปะธะท ะบะฐะปะพัะธะนะฝะพััะธ ะธ ัะพััะฐะฒะฐ ะฑะปัะดะฐ.
* `analyze_recipe(image_bytes, comment)` โ ะณะตะฝะตัะฐัะธั ัะตัะตะฟัะฐ ะธ ัะพะฒะตัะพะฒ ะฟะพ ะฟัะธะณะพัะพะฒะปะตะฝะธั.

ะัะฟะพะปัะทัะตั ะฟัะพะผะฟัั ะธะท `app/prompts/food_analysis.py`.

### `limit_service.py`

* **ะงัะพ ััะพ:** ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ ะปะธะผะธัะพะฒ.
* **ะะฐัะตะผ:** ัะตัะฐะตั, ัะบะพะปัะบะพ ะฐะฝะฐะปะธะทะพะฒ ะดะพัััะฟะฝะพ ะธ ััะพ ัะฟะธััะฒะฐัั.

ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:

* `get_limits_for_user(is_premium)` โ ะฒะพะทะฒัะฐัะฐะตั `(daily_limit, refinement_limit)`.
* `get_user_today_analyses(user_id, date_)` โ ัะบะพะปัะบะพ ะฐะฝะฐะปะธะทะพะฒ ัะถะต ัะดะตะปะฐะฝะพ ัะตะณะพะดะฝั.
* `consume_photo_quota(user_id, is_premium)`:

  * ัะฟะธััะฒะฐะตั ะปะธะฑะพ ะฑะตัะฟะปะฐัะฝัะน ะปะธะผะธั, ะปะธะฑะพ `User.paid_photos_balance`;
  * ะฒะพะทะฒัะฐัะฐะตั `(allowed, used, daily_limit)`.

### `promo_service.py`

* **ะงัะพ ััะพ:** ะปะพะณะธะบะฐ ะฟัะพะผะพะบะพะดะพะฒ (ะตัะปะธ ะฒัะฝะตัะตะฝะฐ ะธะท `premium.py`).
* **ะะฐัะตะผ:** ะพัะดะตะปัะตั ัะฐะฑะพัั ั ะฟัะพะผะพะบะพะดะฐะผะธ ะพั Telegram-ัะตะฝะดะปะตัะพะฒ.

ะะดะตัั ะผะพะณัั ะฑััั:

* ััะฝะบัะธะธ ัะพะทะดะฐะฝะธั ะฟัะพะผะพะบะพะดะพะฒ;
* ะฟัะพะฒะตัะบะธ ะฐะบัะธะฒะฐัะธะน;
* ะพะฑัััะบะธ ะฝะฐะด ะผะพะดะตะปัะผะธ `PromoCode`, `PromoBan`, `PromoCodeActivation`.

### `user_service.py`

* **ะงัะพ ััะพ:** ัะฐะฑะพัะฐ ั ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ.
* **ะะฐัะตะผ:** ะฟัะตะดะพััะฐะฒะปัะตั ัะดะพะฑะฝัะต ััะฝะบัะธะธ ะฒะผะตััะพ ะฟััะผะพะน ัะฐะฑะพัั ั ัะตะฟะพะทะธัะพัะธะตะผ ะธะปะธ ะผะพะดะตะปัะผะธ.

ะะฐะฟัะธะผะตั:

* `get_or_create_user(telegram_id)` โ ะพัะฝะพะฒะฝะฐั ัะพัะบะฐ ะฟะพะปััะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั.
* ััะฝะบัะธะธ ะพะฑะฝะพะฒะปะตะฝะธั ะฟัะตะผะธัะผะฐ, ะพะฑะฝัะปะตะฝะธั ะปะธะผะธัะพะฒ ะธ ั.ะฟ.

---

## 9. ะัะพะณะพะฒะฐั ะบะฐััะธะฝะฐ ัะปะพัะฒ

* **UI-ัะปะพะน (Telegram):**

  * `app/bot/handlers/`
  * `app/bot/keyboards.py`
  * `app/bot/states.py`
  * `app/bot/middlewares/`

* **ะะธะทะฝะตั-ะปะพะณะธะบะฐ:**

  * `app/services/`
  * `app/prompts/`
  * ัะฐััั ะปะพะณะธะบะธ ะฒ `premium.py`, `analysis.py`, `profile.py`.

* **ะะฐะฝะฝัะต:**

  * `app/db/base.py`
  * `app/db/models.py`
  * `app/db/repositories/`

* **ะะพะฝัะธะณััะฐัะธั ะธ ัะตะบััั:**

  * `app/config.py`
  * `app/config_limits.py`
  * `app/locales/ru/`

* **ะะฝััะฐััััะบัััะฐ ะธ ะดะพะบัะผะตะฝัะฐัะธั:**

  * `docker-compose.yml`
  * `Makefile`
  * `requirements.txt`
  * `docs/`
  * `scripts/`

ะญัะฐ ััััะบัััะฐ ะฟะพะทะฒะพะปัะตั:

* ะธะทะพะปะธัะพะฒะฐัั Telegram-ัะปะพะน ะพั ะฑะธะทะฝะตั-ะปะพะณะธะบะธ;
* ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพ ัะฟัะฐะฒะปััั ะปะธะผะธัะฐะผะธ ะธ ัะฐัะธัะฐะผะธ;
* ะดะตัะถะฐัั ะฒัะต ัะตะบััั ะฒ ะพะดะฝะพะผ ะผะตััะต;
* ัะฒะพะปััะธะพะฝะธัะพะฒะฐัั ะะ ัะตัะตะท ะผะธะณัะฐัะธะธ, ะฝะต ะปะพะผะฐั ะฟัะพะด ััะบะฐะผะธ.

```

--- 

---

## 3. ะะพะบัะผะตะฝัะฐัะธั ะฟะพ ะบะพะดั (ัะตัะฝะธัะตัะบะพะต ะพะฟะธัะฐะฝะธะต)

ะญัะพ ะผะพะถะฝะพ ะพัะพัะผะธัั ะฒ `ARCHITECTURE.md` ะธะปะธ `TECHNICAL_OVERVIEW.md`. ะะธะถะต ัะตะบัั, ะบะพัะพััะน ะผะพะถะฝะพ ะฟััะผะพ ะฟะพะปะพะถะธัั ะฒ ัะตะฟั (ะฟัะธ ะถะตะปะฐะฝะธะธ ั ะฟะพัะพะผ ะฟะพะผะพะณั ะดะพะฟะธะปะธัั ะฟะพะด ัะฐะบัะธัะตัะบะธะน ะบะพะด).

````markdown
# DishVisionBot โ ัะตัะฝะธัะตัะบะธะน ะพะฑะทะพั

## 1. ะะฑัะฐั ะฐััะธัะตะบัััะฐ

ะัะธะปะพะถะตะฝะธะต โ ััะพ Telegram-ะฑะพั ะฝะฐ `aiogram`, ะบะพัะพััะน:

- ะฟัะธะฝะธะผะฐะตั ัะพัะพ ะตะดั ะพั ะฟะพะปัะทะพะฒะฐัะตะปั;
- ะพัะฟัะฐะฒะปัะตั ะธั ะฒ GPT ะดะปั ะฐะฝะฐะปะธะทะฐ ะบะฐะปะพัะธะนะฝะพััะธ ะธ ัะตัะตะฟัะฐ;
- ััะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะปะธะผะธัั ะธ ะฟะพะบัะฟะบะธ ะฒ PostgreSQL;
- ัะฟัะฐะฒะปัะตั ัะฐัะธัะฐะผะธ (ะฑะตัะฟะปะฐัะฝัะน / ะฟัะตะผะธัะผ) ะธ ะฟะปะฐัะฝัะผะธ ะฐะฝะฐะปะธะทะฐะผะธ ัะตัะตะท Telegram Stars.

ะัะฝะพะฒะฝัะต ัะปะพะธ:

- **Bot layer (`app/bot/โฆ`)** โ ัะตะฝะดะปะตัั Telegram-ัะพะพะฑัะตะฝะธะน, ัะพััะพัะฝะธั, ะบะปะฐะฒะธะฐัััั.
- **Domain / services (`app/services/โฆ`)** โ ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ: ะปะธะผะธัั, ะฟะพะปัะทะพะฒะฐัะตะปะธ, GPT-ะทะฐะฟัะพัั.
- **Persistence (`app/db/โฆ`)** โ ะผะพะดะตะปะธ SQLAlchemy ะธ ัะตััะธะธ.
- **ะะพะฝัะธะณััะฐัะธั (`app/config*.py`, `app/locales/โฆ`)** โ ะฝะฐัััะพะนะบะธ ะปะธะผะธัะพะฒ, ัะตะบััะพะฒ ะธ ะบะฝะพะฟะพะบ.

## 2. ะขะพัะบะฐ ะฒัะพะดะฐ

### `app/main.py`

ะัะฒะตัะฐะตั ะทะฐ:

- ะทะฐะณััะทะบั ะฝะฐัััะพะตะบ (`Settings` ะธะท `app/config.py`);
- ะธะฝะธัะธะฐะปะธะทะฐัะธั ะะ (`init_db()` ะธะท `app/db/base.py`);
- ัะพะทะดะฐะฝะธะต ัะบะทะตะผะฟะปััะฐ `Bot` ะธ `Dispatcher`;
- ะฟะพะดะบะปััะตะฝะธะต ัะพััะตัะพะฒ ะธะท `app/bot/handlers`;
- ะทะฐะฟััะบ polling (`dp.start_polling(bot)`).

ะัะปะธ ะฝัะถะฝะพ ะทะฐะฟัััะธัั ะฑะพัะฐ ะปะพะบะฐะปัะฝะพ โ ะธัะฟะพะปัะทัะตััั `make restart`, ะบะพัะพััะน ะฒ ะธัะพะณะต ะฒัะทัะฒะฐะตั `python -m app.main`.

## 3. ะะพะฝัะธะณััะฐัะธั

### `app/config.py`

Pydantic Settings:

- `bot_token`, `openai_api_key` โ ัะพะบะตะฝั.
- `database_url` โ ัััะพะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ PostgreSQL (asyncpg).
- `default_language`, `log_level`, `api_timeout`, `max_file_size`.
- `admin_user_ids` โ ัะฟะธัะพะบ Telegram ID ะฐะดะผะธะฝะพะฒ (ัะตัะตะท ะทะฐะฟัััั).

ะะพะฝัะธะณััะฐัะธั ัะธัะฐะตััั ะธะท `.env`.

### `app/config_limits.py`

ะะฐะดะฐัั ะฑะธะทะฝะตั-ะฝะฐัััะพะนะบะธ:

- ะดะฝะตะฒะฝัะต ะปะธะผะธัั ะฐะฝะฐะปะธะทะพะฒ ะธ ััะพัะฝะตะฝะธะน:
  - `FREE_DAILY_ANALYSES`
  - `PREMIUM_DAILY_ANALYSES`
  - `FREE_REFINEMENTS`
  - `PREMIUM_REFINEMENTS`
- ะพะณัะฐะฝะธัะตะฝะธั ะฟะพ ัะตััะธะธ:
  - `PHOTO_SESSION_MAX_MESSAGES`
  - `PHOTO_SESSION_TIMEOUT_MINUTES`
- ะฟะฐัะฐะผะตััั Telegram Stars:
  - `STARS_PREMIUM_WEEK`
  - `STARS_PREMIUM_MONTH`
  - `PRICE_PER_ANALYSIS = {"number_of_analyses": 5, "price": <N_STARS>}`

ะัะต ะธะทะผะตะฝะตะฝะธั ะฟะพ ัะฐัะธัะฐะผ ะธ ัะตะฝะฐะผ ะดะตะปะฐัััั ะทะดะตัั.

## 4. ะะฐะทะฐ ะดะฐะฝะฝัั

### `app/db/models.py`

SQLAlchemy-ะผะพะดะตะปะธ (async):

- `User`:
  - `id` (PK), `telegram_id` (ัะฝะธะบะฐะปัะฝัะน),
  - `is_premium: bool`,
  - `premium_until: datetime | None`,
  - `paid_photos_balance: int` โ ะบัะฟะปะตะฝะฝัะต ะฐะฝะฐะปะธะทั (ะฟะฐะบะตัั ะทะฐ Stars),
  - timestamps.

- `UserLimits` (ะธะปะธ `user_limits`):
  - `user_id` (FK โ User),
  - `date` (ะดะฐัะฐ),
  - `photos_used`, `refinements_used` โ ัะบะพะปัะบะพ ะฟะพััะฐัะตะฝะพ ะทะฐ ะดะตะฝั.

- ะัะพะผะพะบะพะดั:
  - `PromoCode` โ ะบะพะด, ััะพะบ ะดะตะนััะฒะธั, ะบะพะป-ะฒะพ ะดะฝะตะน ะฟัะตะผะธัะผะฐ, ะปะธะผะธั ะฐะบัะธะฒะฐัะธะน, ัััััะธะบ.
  - `PromoCodeActivation` โ ัะฒัะทั ะฟัะพะผะพะบะพะด โ ะฟะพะปัะทะพะฒะฐัะตะปั.
  - `PromoBan` โ ะฑะฐะฝ ะฝะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟัะพะผะพะบะพะดะพะฒ.

(ะะฐะทะฒะฐะฝะธั ะผะพะณัั ะฝะตะผะฝะพะณะพ ะพัะปะธัะฐัััั, ะฝะพ ัะผััะป ัะฐะบะพะน.)

### `app/db/base.py`

- `engine`, `AsyncSessionLocal` โ ัะพะทะดะฐะฝะธะต async-ัะตััะธะน.
- `init_db()` โ ะฟัะพะบะธะดัะฒะฐะตััั ะฒ `main.py` ะดะปั ะธะฝะธัะธะฐะปะธะทะฐัะธะธ.

## 5. ะะพะณะธะบะฐ ะปะธะผะธัะพะฒ ะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### `app/services/user_service.py`

- `get_or_create_user(telegram_id: int)`:
  - ะธัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพ `telegram_id`;
  - ะตัะปะธ ะฝะตั โ ัะพะทะดะฐัั ะทะฐะฟะธัั ะฒ `User`;
  - ะธัะฟะพะปัะทัะตััั ะฟะพััะธ ะฒ ะบะฐะถะดะพะผ ัะตะฝะดะปะตัะต.

ะะพะฟ. ััะฝะบัะธะธ (ะตัะปะธ ะตััั):

- ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะตะผะธัะผะฐ,
- ะฟะพะปััะตะฝะธะต ะฟัะพัะธะปั ะธ ั.ะฟ.

### `app/services/limit_service.py`

ะัะฒะตัะฐะตั ะทะฐ ะปะธะผะธัั:

- `get_limits_for_user(is_premium: bool) -> tuple[int, int]`:
  - ะฒะพะทะฒัะฐัะฐะตั `(daily_analyses_limit, refinement_limit)` ะฝะฐ ะพัะฝะพะฒะต ัะฐัะธัะฐ.

- `get_user_today_analyses(user_id: int, date_: date) -> int | None`:
  - ะฒะพะทะฒัะฐัะฐะตั, ัะบะพะปัะบะพ ะฐะฝะฐะปะธะทะพะฒ ัะดะตะปะฐะฝะพ ะทะฐ ะดะตะฝั (ััะธัะฐะตั ะฟะพ `UserLimits`).

- `consume_photo_quota(user_id: int, is_premium: bool)`
  - ะบะปััะตะฒะฐั ััะฝะบัะธั:
    - ะฟัะพะฒะตััะตั `UserLimits` ะฝะฐ ัะตะณะพะดะฝั;
    - ะตัะปะธ ะตััั ะฑะตัะฟะปะฐัะฝัะน ะปะธะผะธั โ ัะฟะธััะฒะฐะตั ะตะณะพ;
    - ะตัะปะธ ะฑะตัะฟะปะฐัะฝัะน ะปะธะผะธั ะธััะตัะฟะฐะฝ, ะฝะพ `User.paid_photos_balance > 0` โ ัะฟะธััะฒะฐะตั ะฟะปะฐัะฝัะน ะฑะฐะปะฐะฝั;
    - ะฒะพะทะฒัะฐัะฐะตั `(allowed, used, daily_limit)`.

ะะผะตะฝะฝะพ ัะตัะตะท `consume_photo_quota` ะฟัะพะธััะพะดะธั ัะฟะธัะฐะฝะธะต ะปะธะผะธัะฐ ะฟัะธ ะฟะตัะฒะพะผ ะฐะฝะฐะปะธะทะต ะฝะพะฒะพะณะพ ัะพัะพ.

## 6. ะะพะบะฐะปะธะทะฐัะธั (ัะตะบััั ะธ ะบะฝะพะฟะบะธ)

### `app/locales/ru/buttons.py`

- ะกะพะดะตัะถะธั ะบะปะฐัั `RussianButtons` ั ะผะตัะพะดะฐะผะธ `get(key: str)`.
- ะัะต ะฒะธะดะธะผัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะดะฟะธัะธ ะบะฝะพะฟะพะบ:
  - `"analyze_food"`, `"profile"`, `"buy_premium"`, `"help"`, `"nutrition"`, `"recipe"`, `"new_photo"`, `"back"` ะธ ั.ะด.
- ะฅะตะฝะดะปะตัั ััะฐะฒะฝะธะฒะฐัั `message.text` ะธะผะตะฝะฝะพ ั `B.get("...")`.

### `app/locales/ru/texts.py`

- `RussianTexts` ั `get(key: str, **kwargs)`.
- ะกะพะดะตัะถะธั:
  - `start_welcome` โ ะฑะพะปััะพะน ัะฟัะฐะฒะพัะฝัะน ัะตะบัั.
  - `welcome_free` / `welcome_premium` โ ะบะพัะพัะบะธะต ะฟัะธะฒะตัััะฒะธั ะฟะพ ัะฐัะธัะฐะผ.
  - `help_text` โ ัะฟัะฐะฒะบะฐ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั.
  - `daily_limit_exceeded`, `buy_additional_analyses`, `photo_received_options`, `refinement_limit_reached` ะธ ั.ะฟ.
  - ะขะตะบััั ะฟัะพัะธะปั:
    - ัััะพะบะฐ ะฟัะพ ะฟะพะดะฟะธัะบั (ะฑะตัะฟะปะฐัะฝัะน/ะฟัะตะผะธัะผ),
    - ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ะฑะปะพะบะพะฒ ะฟัะพ ะปะธะผะธัั ะธ ะบัะฟะปะตะฝะฝัะต ะฐะฝะฐะปะธะทั.

ะัะต ะธะทะผะตะฝะตะฝะธั ัะตะบััะพะฒ โ ะทะดะตัั (ะบะพะด ัะพะปัะบะพ ะฟะพะดััะฐะฒะปัะตั ะทะฝะฐัะตะฝะธั).

## 7. Telegram-ัะปะพะน: handlers, states, keyboards

### `app/bot/states.py`

- ะะฟะธััะฒะฐะตั FSM-ัะพััะพัะฝะธั `aiogram`:
  - `UserStates.STANDARD` โ ะพะฑััะฝะพะต ัะพััะพัะฝะธะต (ะณะปะฐะฒะฝะพะต ะผะตะฝั).
  - `UserStates.PHOTO_COMMENT` โ ัะตะถะธะผ ัะฐะฑะพัั ั ัะตะบััะธะผ ัะพัะพ (ะบะพะผะผะตะฝัะฐัะธะธ, ััะพัะฝะตะฝะธั).
  - `UserStates.PROMO` โ ะฒะฒะพะด ะฟัะพะผะพะบะพะดะฐ.
  - ะะดะผะธะฝัะบะธะต ัะพััะพัะฝะธั (ะตัะปะธ ะตััั).

ะกะพััะพัะฝะธั ะธัะฟะพะปัะทััััั ะฒ ะดะตะบะพัะฐัะพัะฐั `@router.message(UserStates.STANDARD, ...)` ะธ ั.ะด.

### `app/bot/keyboards.py`

- **`main_menu_kb()`**:
  - ะะปะฐะฒะธะฐัััะฐ ะณะปะฐะฒะฝะพะณะพ ะผะตะฝั:
    - ยซะะฝะฐะปะธะทะธัะพะฒะฐัั ะตะดัยป
    - ยซะัะพัะธะปัยป
    - ยซะัะฟะธัั ะฟัะตะผะธัะผยป
    - ยซะะพะผะพััยป

- **`analysis_menu_kb(disable_buttons=False)`**:
  - ะะปะฐะฒะธะฐัััะฐ ะฒ ัะตะถะธะผะต ะฐะฝะฐะปะธะทะฐ:
    - ยซะะฐะปะพัะธะนะฝะพัััยป
    - ยซะะตัะตะฟัยป
    - ยซะะพะฒะพะต ัะพัะพยป
    - ยซะะฐะทะฐะดยป

- **`premium_menu_kb()`**:
  - ะะตะฝั ะฟัะตะผะธัะผะฐ:
    - ยซะัะฟะธัั ะฝะฐ ะฝะตะดะตะปัยป
    - ยซะัะฟะธัั ะฝะฐ ะผะตัััยป
    - ยซะะฒะตััะธ ะฟัะพะผะพะบะพะดยป
    - ยซะะฐะทะฐะดยป

- **`buy_more_analyses_inline_kb()`**:
  - ะะฝะปะฐะนะฝ-ะบะฝะพะฟะบะฐ `ะัะฟะธัั 5 ะฐะฝะฐะปะธะทะพะฒ โญ` โ `callback_data="buy_analyses_pack"`.

- **`admin_menu_kb()`, `admin_limits_menu_kb()`**:
  - ะะปะฐะฒะธะฐัััั ะฐะดะผะธะฝะบะธ.

### ะฅะตะฝะดะปะตัั

#### `app/bot/handlers/main_menu.py`

ะัะฒะตัะฐะตั ะทะฐ:

- `/start`:
  - ัะฑัะฐััะฒะฐะตั ัะพััะพัะฝะธะต ะฒ `UserStates.STANDARD`;
  - ะพัะฟัะฐะฒะปัะตั `start_welcome` (ัะฐััะธัะตะฝะฝัะน ัะตะบัั);
  - ะทะฐัะตะผ ะฟัะธะฒะตัััะฒะธะต/ััะฐััั (ัะตะนัะฐั ะผะพะถะฝะพ ะทะฐะผะตะฝะธัั ะฝะฐ ะฒัะฒะพะด ะฟัะพัะธะปั).

- ะะฝะพะฟะบะฐ **ยซะะฝะฐะปะธะทะธัะพะฒะฐัั ะตะดัยป**:
  - ะฟะพะดััะณะธะฒะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั;
  - ัะผะพััะธั ะปะธะผะธัั (ะฑะตัะฟะปะฐัะฝัะต + ะฟะปะฐัะฝัะต);
  - ะตัะปะธ ัะพะฒัะตะผ ะฝะตั ะปะธะผะธัะพะฒ โ ัะปัั ัะตะบัั ะฟัะพ ะธััะตัะฟะฐะฝะฝัะต ะปะธะผะธัั + ะธะฝะปะฐะนะฝ-ะบะฝะพะฟะบั ะฟะพะบัะฟะบะธ;
  - ะตัะปะธ ะปะธะผะธัั ะตััั โ ััะฐะฒะธั ัะพััะพัะฝะธะต `PHOTO_COMMENT` ะธ ะฟะธัะตั `send_photo_for_analysis`.

- ะะฝะพะฟะบะฐ **ยซะะพะผะพััยป**:
  - ะฟะพะบะฐะทัะฒะฐะตั ะดะปะธะฝะฝัั ัะฟัะฐะฒะบั (`start_welcome`).

- ะะฝะพะฟะบะฐ **ยซะัะพัะธะปัยป**:
  - ัะตะนัะฐั ะทะฐะณะปััะบะฐ, ัะตะฐะปัะฝะฐั ะปะพะณะธะบะฐ ะฒ `profile.py`.

- ะะฝะพะฟะบะฐ **ยซะัะฟะธัั ะฟัะตะผะธัะผยป**:
  - ะฟะพะบะฐะทัะฒะฐะตั `premium_info` + `premium_menu_kb()`.

#### `app/bot/handlers/analysis.py`

ะะปะฐะฒะฝะพะต ะผะตััะพ:

- ะะฑัะฐะฑะพััะธะบ `@router.message(F.photo)`:
  - ะฟัะพะฒะตััะตั, ััะพ ะตััั ะธะปะธ ะฑะตัะฟะปะฐัะฝัะน, ะธะปะธ ะฟะปะฐัะฝัะน ะปะธะผะธั;
  - ัะพััะฐะฝัะตั `file_id` ะธ ะบะพะผะผะตะฝัะฐัะธะน ะฒ `FSMContext`;
  - ััะฐะฒะธั `UserStates.PHOTO_COMMENT`;
  - ะฟะพะบะฐะทัะฒะฐะตั ะฒะฐัะธะฐะฝัั: ะบะฐะปะพัะธะนะฝะพััั / ัะตัะตะฟั.

- ะะฑัะฐะฑะพััะธะบ **ยซะะฐะปะพัะธะนะฝะพัััยป**:
  - ะฟัะธ ะฟะตัะฒะพะผ ะฒัะทะพะฒะต ะดะปั ัะพัะพ:
    - ัะตัะตะท `_check_and_increment_daily_limit()` ะฒัะทัะฒะฐะตั `consume_photo_quota()` โ ัะฟะธััะฒะฐะตั ะปะธะฑะพ ะฑะตัะฟะปะฐัะฝัะน, ะปะธะฑะพ ะฟะปะฐัะฝัะน ะปะธะผะธั;
  - ะฒัะทัะฒะฐะตั `analyze_nutrition()` ะธะท `gpt_client`;
  - ัะพััะฐะฝัะตั, ััะพ ัะถะต ะฑัะป ะฐะฝะฐะปะธะท ะดะปั ััะพะณะพ ัะพัะพ.

- ะะฑัะฐะฑะพััะธะบ **ยซะะตัะตะฟัยป**:
  - ะฐะฝะฐะปะพะณะธัะฝะพ, ะฝะพ ัะตัะตะท `analyze_recipe()`.

- ะะฑัะฐะฑะพััะธะบ ัะตะบััะพะฒัั ััะพัะฝะตะฝะธะน ะฒ ัะพััะพัะฝะธะธ `PHOTO_COMMENT`:
  - ะฝะฐะบะฐะฟะปะธะฒะฐะตั ะบะพะผะผะตะฝัะฐัะธะน;
  - ะฟัะธ ะฟัะตะฒััะตะฝะธะธ `PHOTO_SESSION_MAX_MESSAGES` ะผะพะถะตั ะฐะฒัะพะผะฐัะพะผ ะทะฐะฟัััะธัั ะฐะฝะฐะปะธะท;
  - ะพะณัะฐะฝะธัะธะฒะฐะตั ะบะพะปะธัะตััะฒะพ ััะพัะฝะตะฝะธะน `refinements_used` ะพัะฝะพัะธัะตะปัะฝะพ ะปะธะผะธัะฐ.

- ะะฑัะฐะฑะพััะธะบ **ยซะะพะฒะพะต ัะพัะพยป**:
  - ัะฑัะฐััะฒะฐะตั ัะพััะพัะฝะธะต ัะตะบััะตะณะพ ัะพัะพ;
  - ะตัั ัะฐะท ะฟัะพะฒะตััะตั ะปะธะผะธัั (ะฑะตัะฟะปะฐัะฝัะต + ะฟะปะฐัะฝัะต);
  - ะปะธะฑะพ ะณะพะฒะพัะธั ยซะปะธะผะธัั ะธััะตัะฟะฐะฝัยป + ะฟะพะบะฐะทัะฒะฐะตั ะบะฝะพะฟะบั ะฟะพะบัะฟะบะธ, ะปะธะฑะพ ะฟัะพัะธั ะฟัะธัะปะฐัั ะฝะพะฒะพะต ัะพัะพ.

#### `app/bot/handlers/premium.py`

- ะัะบัััะธะต ะผะตะฝั ะฟัะตะผะธัะผะฐ (`open_premium_menu`).
- ะะฒะพะด ะฟัะพะผะพะบะพะดะฐ:
  - `on_enter_promo` โ ััะฐะฒะธั ัะพััะพัะฝะธะต `PROMO`;
  - `on_promo_input` โ ัะธัะฐะตั ะบะพะด, ะฟัะพะฒะตััะตั ะฑะฐะฝ/ะฒะฐะปะธะดะฝะพััั/ะปะธะผะธัั;
  - `_apply_promo_code()`:
    - ะฟัะพะฒะตััะตั ััะพะบ ะดะตะนััะฒะธั, ะปะธะผะธั ะฐะบัะธะฒะฐัะธะน, ัะถะต ะธัะฟะพะปัะทะพะฒะฐะฝะฝัะต ะบะพะดั;
    - ะฟัะพะดะปะตะฒะฐะตั `user.premium_until` ะฝะฐ `promo.days`;
    - ะฒัััะฐะฒะปัะตั `user.is_premium = True`;
    - ัะพะทะดะฐัั `PromoCodeActivation`.

#### `app/bot/handlers/payments.py`

- ะัะธะฝะธะผะฐะตั ะพะฟะปะฐัั ัะตัะตะท Telegram Stars:

  - ะะฑัะฐะฑะพััะธะบะธ:
    - `on_buy_premium_week` / `on_buy_premium_month` โ ะพัะฟัะฐะฒะบะฐ `send_invoice` ั `payload="premium_week"` / `"premium_month"`.
    - `on_buy_analyses_pack` โ ะธะฝะฒะพะนั ะฝะฐ ะฟะฐะบะตั ะฐะฝะฐะปะธะทะพะฒ (`analyses_pack`).
    - `process_pre_checkout_query` โ ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะฟัะตะดะพะฟะปะฐัั.
    - `on_successful_payment`:
      - ะฟะพ `payload`:
        - `premium_week` / `premium_month` โ ะฒะบะปััะฐะตั ะฟัะตะผะธัะผ.
        - `analyses_pack` โ ัะฒะตะปะธัะธะฒะฐะตั `user.paid_photos_balance` ะฝะฐ `PRICE_PER_ANALYSIS["number_of_analyses"]`.

#### `app/bot/handlers/profile.py`

- ะคะพัะผะธััะตั ัะตะบัั ะฟัะพัะธะปั:

  - ััะธัะฐะตั:
    - `free_left` / `used` (ะฟะพ ะปะธะผะธัะฐะผ ะทะฐ ัะตะณะพะดะฝั);
    - `paid_left` (`paid_photos_balance`);
    - ะพะฑัะธะน ะดะพัััะฟะฝัะน ะปะธะผะธั.
  - ะะพะทะฒัะฐัะฐะตั ัะพัะผะฐัะธัะพะฒะฐะฝะฝัะน ัะตะบัั:

    ```text
    โญ๏ธ ะะพะดะฟะธัะบะฐ: ะะตัะฟะปะฐัะฝัะน
    ะกะตะณะพะดะฝั ะฒั ะผะพะถะตัะต ัะดะตะปะฐัั: N ะฐะฝะฐะปะธะทะพะฒ.

    ๐ธ ะะฝะฐะปะธะทั ัะตะณะพะดะฝั:
    โข ะธัะฟะพะปัะทะพะฒะฐะฝะพ: X ะธะท Y
    โข ะพััะฐะปะพัั ัะตะณะพะดะฝั: Z

    ๐ฐ ะัะฟะปะตะฝะฝัะต ะฐะฝะฐะปะธะทั:
    โข ะดะพัััะฟะฝะพ: K
    โข ะพะฝะธ ะฝะต ัะณะพัะฐัั ะธ ะฝะต ะทะฐะฒะธััั ะพั ะดะฝะตะฒะฝะพะณะพ ะปะธะผะธัะฐ
    ```

- ะฅะตะฝะดะปะตั ะฝะฐ ะบะฝะพะฟะบั ยซะัะพัะธะปัยป ะฟะพะบะฐะทัะฒะฐะตั ััะพั ัะตะบัั + ะบะปะฐะฒะธะฐัััั ะฟัะพัะธะปั (ะธะปะธ ะฟัะพััะพ back).

#### `app/bot/handlers/admin.py`

- ะะดะผะธะฝ-ะบะพะผะฐะฝะดั:
  - ะฟัะพัะผะพัั ััะฐัะธััะธะบะธ;
  - `admin_limits_reset_me` โ ัะฑัะพั ัะฒะพะธั ะปะธะผะธัะพะฒ;
  - `admin_premium_on_me` / `admin_premium_off_me` โ ะฒะบะปััะตะฝะธะต/ะฒัะบะปััะตะฝะธะต ะฟัะตะผะธัะผะฐ;
  - `admin_limits_reset_other` โ ัะฑัะพั ะปะธะผะธัะพะฒ ะดััะณะพะณะพ ัะทะตัะฐ;
  - ัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะผะพะบะพะดะฐะผะธ.

## 8. GPT-ะบะปะธะตะฝั

### `app/services/gpt_client.py`

- `analyze_nutrition(image_bytes: bytes, comment: str | None) -> str`:
  - ะพัะฟัะฐะฒะปัะตั ะบะฐััะธะฝะบั + ะพะฟัะธะพะฝะฐะปัะฝัะน ัะตะบัั ะฒ OpenAI;
  - ะฒะพะทะฒัะฐัะฐะตั ัะตะบัั ั ะพัะตะฝะบะพะน ะบะฐะปะพัะธะน/ะะะฃ ะธ ั.ะฟ.

- `analyze_recipe(image_bytes: bytes, comment: str | None) -> str`:
  - ะฐะฝะฐะปะพะณะธัะฝะพ, ะฝะพ ั ัะพะบััะพะผ ะฝะฐ ัะตัะตะฟั/ัะฟะพัะพะฑ ะฟัะธะณะพัะพะฒะปะตะฝะธั.

ะัะพะผะฟัั ะธ ัะธััะตะผะฝัะต ะธะฝััััะบัะธะธ ะทะฐะบะพะดะธัะพะฒะฐะฝั ะฒะฝัััะธ (ะฒะพะทะผะพะถะฝะพ, ะพัะดะตะปัะฝัะผ ัะฐะนะปะพะผ).

---

ะญัะพ ะฒัั ะผะพะถะฝะพ ะพัะพัะผะธัั ะฒ ะพะดะธะฝ `ARCHITECTURE.md` ะธ ะฟะพะปะพะถะธัั ะฒ ะบะพัะตะฝั ัะตะฟั โ ััะพ ัะธะปัะฝะพ ะฟะพะผะพะถะตั, ะบะพะณะดะฐ ะฑัะดะตัั ะดะตะปะฐัั ะดะตะฟะปะพะน ะฒ ะฟัะพะด ะฒ ัะพัะตะดะฝะตะผ ัะฐัะต.

