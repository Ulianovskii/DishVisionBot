# 6. Защита от злоупотреблений и лимиты

Этот документ описывает механики защиты от недобросовестного использования бота и чрезмерного расхода токенов GPT.

## 6.1. Лимиты по тарифам

- **Бесплатный тариф:**
  - 5 фото (анализов) в день
  - 2 уточнения на фото (повторные запросы к GPT по тому же фото)
- **Премиум тариф:**
  - 15 фото (анализов) в день
  - 5 уточнений на фото

Лимиты применяются **по пользователю** и **по дате (локальное время сервера)**.

## 6.2. Лимиты на сообщения в сессии анализа

- Для каждого фото в состоянии `STATE_PHOTO_COMMENT`:
  - не более **10 текстовых сообщений** от пользователя.
- После достижения лимита:
  - бот отправляет `<message max_messages_for_photo>`
  - автоматически запускает анализ (как будто нажата кнопка `Калорийность`/`Рецепт`).

## 6.3. Тайм-ауты сессий

- Сессия анализа (`STATE_PHOTO_COMMENT`) сбрасывается по тайм-ауту 60 минут:
  - очищаются привязанные к фото комментарии
  - обнуляются счетчики сообщений
  - пользователь возвращается в `STATE_STANDARD`.

## 6.4. Защита от спама и off-topic

- Если текстовые сообщения пользователя:
  - явно не про еду / рецепты
  - содержат брань, бессмысленный набор символов, повторяющиеся паттерны
- Бот:
  - не передает такие сообщения в GPT
  - отвечает `<message off_topic_warning>`
  - при этом попытка «уточнения» списывается (уменьшается лимит уточнений).

## 6.5. Антифлуд по промокодам

- В состоянии `STATE_PROMO`:
  - до 10 неверных попыток ввода промокода подряд.
- После 10 неверных попыток:
  - устанавливается бан на 30 минут (запись в таблице `promo_bans`).
- После следующей серии 10 неверных попыток:
  - бан на 24 часа.
- После третьей серии:
  - бан на неделю (можно настроить).
- При активном бане:
  - бот не проверяет введенные промокоды
  - отвечает `<message promo_banned_until>`.

## 6.6. Антифлуд по фото и комментариям

- Рекомендуется логировать сценарии, при которых:
  - пользователь за короткий промежуток времени отправляет много фото с большим количеством мусорных комментариев.
- В первой версии:
  - таких пользователей можно помечать флагом `is_suspicious` в таблице `users`
  - ограничивать им лимиты (например, снижать дневной лимит фото до 1–2 или запрещать уточнения).
- Расширение:
  - реализовать глобальный «мягкий бан» (без прямого блокирования Telegram, но с отключением GPT-логики).

