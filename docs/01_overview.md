# Food Lens — техническое задание

## 1. Общее описание

DishVisionBot — интеллектуальный Telegram-бот для анализа питания по фотографиям. Бот использует AI для определения пищевой ценности блюд и описания рецепта блюда с фото.

Помимо фото еды бот принимает текстовые уточнения по фото от пользователя. После проведения анализа фото пользователь может ввести текстовые корректировки и бот переделает анализ в соответствии с новой информацией.

Бот **не хранит** персональные данные пользователей, историю переписки и отправленные фото (кроме необходимого минимума для технического логирования и отладки).

Бот анализирует все блюда на фото, в том числе напитки. Если на фото несколько блюд, бот учитывает все блюда раздельно. Если бот затрудняется определить по фото, что именно на нем изображено, бот делает лучшее предположение и просит пользователя уточнить текстом то, что он видит на фото.

Помимо инструментов анализа бот хранит профиль пользователя. Пользователь может отмечать блюда как съеденные, и бот будет учитывать количество потребленных калорий. В профиле пользователь может указать плановое количество калорий, которые он хочет потреблять. Бот может формировать отчеты:

- Сколько калорий было съедено за день
- Сводка по дням за неделю и за месяц
- Когда пользователь выходил за целевые рамки по калориям

В отчетах бот хранит и показывает названия и массу съеденных блюд.  
В бот встроена защита от запросов пользователя не по теме блюд и защиты от злоупотреблений.

### 1.1. Тарифы и режимы работы

Бот имеет 2 режима работы: **бесплатный** и **платный (премиум)**.  
Тарифы покупаются на неделю или на месяц с помощью Telegram Stars.

**Бесплатный тариф:**
- Пользователь видит рекламные сообщения
- Ограничение: **5 фото еды в день**
- Возможности анализа: **рецепт блюда**, **калорийность блюда**
- **2 попытки уточнить состав блюда** (текстом после анализа)

**Платный тариф (Премиум):**
- Отсутствие рекламы
- Ограничение: **15 фото еды в день**
- **5 попыток уточнить состав блюда**
- Возможности анализа: рецепт блюда, калорийность блюда
- Персональный профиль:
  - План по калориям в день
  - Учет питания глубиной **12 месяцев**
- Отчеты:
  - Ежедневные
  - Еженедельные
  - Ежемесячные

### 1.2. Ограничения продукта

- Бот **не является медицинским экспертом**, все оценки носит примерный характер.
- Бот **не анализирует качество и опасность блюд для здоровья**.
- Решения по питанию принимает пользователь, владелец продукта ответственности не несет.
- При нарушении лимитов или попытках обхода ограничений бот может ограничить функциональность (мягкий/жесткий бан).

### 1.3. Локализация

- На старте проект работает на русском языке (локаль `ru`).
- Все тексты кнопок и ответов бота хранятся в отдельных файлах локализации:
  - `app/locales/ru/buttons.py`
  - `app/locales/ru/texts.py`
- Промпты в нейросеть оформлены так, чтобы нейросеть отвечала на языке пользователя (на старте — русский).

### 1.4. Архитектура и стек

- **Backend:** Python + Aiogram 3.x
- **AI:** OpenAI GPT‑4 mini с поддержкой Vision
- **База данных:** PostgreSQL + asyncpg
- **Конфигурация:** Python-модули (тексты, промты, лимиты, флаги)
- **Локализация:** Русский (с возможностью добавления языков)
- **Инфраструктура:** Docker, docker-compose, Makefile
- **Finite State Machine (FSM):** для управления режимами ввода и обработки сообщений
- **Оплата:** Telegram Stars

### 1.5. Нагрузочные показатели

- Расчетная нагрузка: **до 20 одновременных пользователей**
- До **1000 уникальных пользователей в месяц**
- Система должна выдерживать пиковые bursts при разумных лимитах на фото/день и уточнения.

### 1.6. Режим дебага

Бот можно переключать в режим дебага (через конфиг или переменные окружения).  
В режиме дебага бот:

- Логирует в консоль все входящие апдейты с ключевыми полями (user_id, тип сообщения, состояние FSM)
- Логирует вызовы основных сервисов (GPT, БД, биллинг, лимиты)
- Может ограничиваться одним тестовым пользователем (whitelist user_id)
